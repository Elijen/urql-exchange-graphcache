"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("graphql"),t=require("urql"),r=require("pessimism"),n=require("wonka");function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var o=function(e){return e.name.value},a=function(e){return e.typeCondition.name.value},s=function(e){return void 0!==e.alias?e.alias.value:o(e)},u=function(e){return void 0!==e.selectionSet?e.selectionSet.selections:[]},c=function(e){var t=e.typeCondition;return void 0!==t?o(t):null},l=function(t){return t.kind===e.Kind.FIELD},f=function(t){return t.kind===e.Kind.INLINE_FRAGMENT},p=function(t,r){if(void 0===t.arguments||0===t.arguments.length)return null;for(var n=Object.create(null),i=0,a=0,s=t.arguments.length;a<s;a++){var u=t.arguments[a],c=e.valueFromASTUntyped(u.value,r);null!=c&&(n[o(u)]=c,i++)}return i>0?n:null},v=function(t,r){if(void 0===t.variableDefinitions)return{};var n=r||{};return t.variableDefinitions.reduce((function(t,r){var i=o(r.variable),a=n[i];if(void 0===a){if(void 0===r.defaultValue)return t;a=e.valueFromASTUntyped(r.defaultValue,n)}return t[i]=a,t}),Object.create(null))},d=function(e,t,r){if(!e){var n=new Error((t||"Minfied Error #"+r+"\n")+"\nhttps://github.com/FormidableLabs/urql-exchange-graphcache/blob/master/docs/help.md#"+r);throw n.name="Graphcache Error",n}},y=function(t){return t.kind===e.Kind.FRAGMENT_DEFINITION};function h(t){return t.kind===e.Kind.OPERATION_DEFINITION}var m=function(e){var t=e.definitions.find(h);return d(!!t,"",1),t};function g(e,t){return e[o(t)]=t,e}var b=function(e){return e.definitions.filter(y).reduce(g,{})},k=function(t,r){var n=t.directives;if(void 0===n)return!0;for(var i=0,a=n.length;i<a;i++){var s=n[i],u=o(s),c="include"===u;if(c||"skip"===u){var l=s.arguments?s.arguments[0]:null;if(l&&"if"===o(l)){var f=e.valueFromASTUntyped(l.value,r);if("boolean"==typeof f||null===f)return c?!!f:!f}}}return!0},_=function(e,r){return r?e+"("+t.stringifyVariables(r)+")":e},O=function(e,t){return e+"."+t},w=function(e,t,r,n){return!(!t||t!==c(e)&&u(e).some((function(e){if(!l(e))return!1;var t=_(o(e),p(e,n.variables));return!n.store.hasField(O(r,t))})))},x=function(e,t,r,n){this.typename=e,this.entityKey=t,this.context=n,this.indexStack=[0],this.selectionStack=[r]};x.prototype.next=function(){for(;0!==this.indexStack.length;){var e=this.indexStack[this.indexStack.length-1]++,t=this.selectionStack[this.selectionStack.length-1];if(e>=t.length)this.indexStack.pop(),this.selectionStack.pop();else{var r=t[e];if(k(r,this.context.variables)){if(l(r)){if("__typename"===o(r))continue;return r}var n=f(r)?r:this.context.fragments[o(r)];void 0!==n&&(void 0!==this.context.schemaPredicates?this.context.schemaPredicates.isInterfaceOfType(c(n),this.typename):w(n,this.typename,this.entityKey,this.context))&&(this.indexStack.push(0),this.selectionStack.push(u(n)))}}}};var N=function(e){return Array.isArray(e)?e.some(N):"object"!=typeof e||null!==e&&"string"!=typeof e.__typename},S=function(e,t,r){M(0);var n=q(e,t,r);return I(),n},q=function(e,t,r){var n=m(t.query),i={dependencies:Q()},o=u(n),a=e.getRootKey(n.operation),s={parentTypeName:a,parentKey:a,parentFieldKey:"",fieldName:"",variables:v(n,t.variables),fragments:b(t.query),result:i,store:e,schemaPredicates:e.schemaPredicates};return a===s.store.getRootKey("query")?R(s,a,o,r):j(s,a,o,r),i},F=function(e,t,r){M(r);var n=m(t.query),i={dependencies:Q()},a=e.getRootKey("mutation"),s=e.getRootKey(n.operation);d(s===a,"",10);for(var c,l={parentTypeName:a,parentKey:a,parentFieldKey:"",fieldName:"",variables:v(n,t.variables),fragments:b(t.query),result:i,store:e,schemaPredicates:e.schemaPredicates,optimistic:!0},f=Object.create(null),y=new x(s,s,u(n),l);void 0!==(c=y.next());)if(void 0!==c.selectionSet){var h=o(c),g=l.store.optimisticMutations[h];if(void 0!==g){l.fieldName=h;var k=p(c,l.variables),_=g(k||Object.create(null),l.store,l);N(_)||A(l,_,u(c)),f[h]=_;var O=l.store.updates[a][h];void 0!==O&&O(f,k||Object.create(null),l.store,l)}}return I(),i},T=function(e,t,r,n){var o=b(t),s=o[Object.keys(o)[0]];if(void 0!==s){var c=a(s),l=i({__typename:c},r),f=e.keyOfEntity(l);if(f){var p={parentTypeName:c,parentKey:f,parentFieldKey:"",fieldName:"",variables:n||{},fragments:o,result:{dependencies:Q()},store:e,schemaPredicates:e.schemaPredicates};R(p,f,u(s),l)}}},R=function(e,t,r,n){var i=e.store,a=t===e.store.getRootKey("query"),c=n.__typename;a||C(t),i.writeField(a?t:c,t,"__typename");for(var l,f=new x(c,t,r,e);void 0!==(l=f.next());){var v=o(l),d=p(l,e.variables),y=O(t,_(v,d)),h=n[s(l)];if(a&&C(y),void 0===l.selectionSet)i.writeRecord(h,y);else if(N(h))i.writeRecord(h,y);else{var m=K(e,y,u(l),h);i.writeConnection(O(t,v),y,d),i.writeLink(m,y),i.removeRecord(y)}}},K=function(e,t,r,n){if(Array.isArray(n)){for(var i=new Array(n.length),o=0,a=n.length;o<a;o++){var s=n[o],u=O(t,""+o),c=K(e,u,r,s);i[o]=c}return i}if(null===n)return null;var l=e.store.keyOfEntity(n),f=null!==l?l:t,p=n.__typename;return void 0===e.store.keys[n.__typename]&&null===l&&!p.endsWith("Connection")&&p.endsWith("Edge"),R(e,f,r,n),f},j=function(e,t,r,n){for(var i,a=t===e.store.getRootKey("mutation")||t===e.store.getRootKey("subscription"),c=new x(t,t,r,e);void 0!==(i=c.next());){var l=o(i),f=p(i,e.variables),v=n[s(i)];if(void 0===i.selectionSet||null===v||N(v)||A(e,v,u(i)),a){e.parentTypeName=t,e.parentKey=t,e.parentFieldKey=O(t,_(l,f)),e.fieldName=l;var d=e.store.updates[t][l];void 0!==d&&d(n,f||Object.create(null),e.store,e)}}},A=function(e,t,r){if(Array.isArray(t)){for(var n=new Array(t.length),i=0,o=t.length;i<o;i++)n[i]=A(e,t[i],r);return n}if(null!==t){var a=e.store.keyOfEntity(t);null!==a?R(e,a,r,t):j(e,t.__typename,r,t)}},L=function(e,t,r){var n,i=e.store,a="Query"===t;if(a)n=t;else{if(C(t),"string"!=typeof(n=i.getField(t,"__typename")))return;i.removeRecord(O(t,_("__typename")))}for(var s,c=new x(n,t,r,e);void 0!==(s=c.next());){var l=o(s),f=O(t,_(l,p(s,e.variables)));if(a&&C(f),void 0===s.selectionSet)i.removeRecord(f);else{var v=u(s),d=i.getLink(f);if(i.removeLink(f),void 0===d)void 0!==i.getRecord(f)&&i.removeRecord(f);else if(Array.isArray(d))for(var y=0,h=d.length;y<h;y++){var m=d[y];null!==m&&L(e,m,v)}else null!==d&&L(e,d,v)}}},P={current:null},E={current:null},M=function(e){P.current=new Set,E.current=e},I=function(){P.current=null,E.current=null},Q=function(){return d(null!==(e=P).current,"",2),e.current;var e},C=function(e){P.current.add(e)},G=function(e,t,n){return r.setOptimistic(e,t,n,E.current||0)},D=function(e,t){var n=E.current||0;return n?r.setOptimistic(e,t,void 0,n):r.remove(e,t)},V=function(e,t,n,i,o){var a;if(this.records=r.asMutable(r.make()),this.connections=r.asMutable(r.make()),this.links=r.asMutable(r.make()),this.resolvers=t||{},this.optimisticMutations=i||{},this.keys=o||{},this.schemaPredicates=e,this.updates={Mutation:n&&n.Mutation||{},Subscription:n&&n.Subscription||{}},e){var s=e.schema,u=s.getQueryType(),c=s.getMutationType(),l=s.getSubscriptionType(),f=u?u.name:"Query",p=c?c.name:"Mutation",v=l?l.name:"Subscription";this.rootFields={query:f,mutation:p,subscription:v},this.rootNames=((a={})[f]="query",a[p]="mutation",a[v]="subscription",a)}else this.rootFields={query:"Query",mutation:"Mutation",subscription:"Subscription"},this.rootNames={Query:"query",Mutation:"mutation",Subscription:"subscription"}};V.prototype.getRootKey=function(e){return this.rootFields[e]},V.prototype.keyOfEntity=function(e){var t,r=e.__typename,n=e.id,i=e._id;return r?void 0!==this.rootNames[r]?r:(this.keys[r]?t=this.keys[r](e):null!=n?t=""+n:null!=i&&(t=""+i),t?r+":"+t:null):null},V.prototype.clearOptimistic=function(e){this.records=r.clearOptimistic(this.records,e),this.connections=r.clearOptimistic(this.connections,e),this.links=r.clearOptimistic(this.links,e)},V.prototype.getRecord=function(e){return r.get(this.records,e)},V.prototype.removeRecord=function(e){return this.records=D(this.records,e)},V.prototype.writeRecord=function(e,t){return this.records=G(this.records,t,e)},V.prototype.getField=function(e,t,r){return this.getRecord(O(e,_(t,r)))},V.prototype.writeField=function(e,t,r,n){return this.records=G(this.records,O(t,_(r,n)),e)},V.prototype.getLink=function(e){return r.get(this.links,e)},V.prototype.removeLink=function(e){return this.links=D(this.links,e)},V.prototype.writeLink=function(e,t){return this.links=G(this.links,t,e)},V.prototype.writeConnection=function(e,t,n){if(void 0!==this.getLink(t)||null===n)return this.connections;var i=r.get(this.connections,e),o=[n,t];if(void 0===i)i=[o];else{for(var a=0,s=i.length;a<s;a++)if(i[a][1]===t)return this.connections;(i=i.slice()).push(o)}return this.connections=G(this.connections,e,i)},V.prototype.resolveValueOrLink=function(e){var t=this.getRecord(e);return void 0!==t?t:this.getLink(e)||null},V.prototype.resolve=function(e,t,r){if(null===e)return null;if("string"==typeof e)return C(e),this.resolveValueOrLink(O(e,_(t,r)));var n=this.keyOfEntity(e);return null===n?null:(C(n),this.resolveValueOrLink(O(n,_(t,r))))},V.prototype.resolveConnections=function(e,t){var n;if("string"==typeof e)n=r.get(this.connections,O(e,t));else if(null!==e){var i=this.keyOfEntity(e);null!==i&&(C(i),n=r.get(this.connections,O(i,t)))}return void 0!==n?n:[]},V.prototype.invalidateQuery=function(e,r){!function(e,t){M(0);var r=m(t.query),n={variables:v(r,t.variables),fragments:b(t.query),store:e,schemaPredicates:e.schemaPredicates};L(n,n.store.getRootKey("query"),u(r)),I()}(this,t.createRequest(e,r))},V.prototype.hasField=function(e){return void 0!==this.getRecord(e)||void 0!==this.getLink(e)},V.prototype.updateQuery=function(e,r){var n=t.createRequest(e.query,e.variables),i=r(this.readQuery(n));null!==i&&q(this,n,i)},V.prototype.readQuery=function(e){return W(this,t.createRequest(e.query,e.variables)).data},V.prototype.readFragment=function(e,t,r){return H(this,e,t,r)},V.prototype.writeFragment=function(e,t,r){T(this,e,t,r)};var U=function(e,t,r){M(0);var n=W(e,t,r);return I(),n},W=function(e,t,r){var n=m(t.query),i=e.getRootKey(n.operation),o=u(n),a={parentTypeName:i,parentKey:i,parentFieldKey:"",fieldName:"",variables:v(n,t.variables),fragments:b(t.query),partial:!1,store:e,schemaPredicates:e.schemaPredicates},s=r||Object.create(null);return s=i!==a.store.getRootKey("query")?z(a,i,o,s):J(a,i,o,s),{dependencies:Q(),partial:void 0!==s&&a.partial,data:void 0===s?null:s}},z=function(e,t,r,n){if("string"!=typeof n.__typename)return n;var i=Object.create(null);i.__typename=n.__typename;for(var o,a=new x(t,t,r,e);void 0!==(o=a.next());){var c=s(o),l=n[c];i[c]=void 0===o.selectionSet||null===l||N(l)?l:B(e,u(o),l)}return i},B=function(e,t,r){if(Array.isArray(r)){for(var n=new Array(r.length),i=0,o=r.length;i<o;i++)n[i]=B(e,t,r[i]);return n}if(null===r)return null;var a=e.store.keyOfEntity(r);if(null!==a){var s=J(e,a,t,Object.create(null));return void 0===s?null:s}return z(e,r.__typename,t,r)},H=function(e,t,r,n){var o=b(t),s=o[Object.keys(o)[0]];if(void 0===s)return null;var c=a(s);"string"==typeof r||r.__typename||(r.__typename=c);var l="string"!=typeof r?e.keyOfEntity(i({__typename:c},r)):r;return l&&J({parentTypeName:c,parentKey:l,parentFieldKey:"",fieldName:"",variables:n||{},fragments:o,partial:!1,store:e,schemaPredicates:e.schemaPredicates},l,u(s),Object.create(null))||null},J=function(e,t,r,n){var i=e.store,a=e.schemaPredicates,c=t===i.getRootKey("query");c||C(t);var l=c?t:i.getField(t,"__typename");if("string"==typeof l){n.__typename=l;for(var f,v=new x(l,t,r,e),d=!1,y=!1;void 0!==(f=v.next());){var h=o(f),m=p(f,e.variables),g=s(f),b=O(t,_(h,m)),k=i.getRecord(b);c&&C(b);var w=void 0,N=i.resolvers[l];if(void 0!==N&&"function"==typeof N[h]){e.parentTypeName=l,e.parentKey=t,e.parentFieldKey=b,e.fieldName=h,void 0!==k&&(n[g]=k);var S=N[h](n,m||Object.create(null),i,e);w=void 0!==f.selectionSet?X(e,l,h,b,u(f),n[g]||Object.create(null),S):void 0===S&&void 0===a?null:S}else if(void 0===f.selectionSet)w=k;else{var q=i.getLink(b);void 0!==q?w=Y(e,q,l,h,u(f),n[g]):"object"==typeof k&&null!==k&&(w=k)}if(void 0===w&&void 0!==a&&a.isFieldNullable(l,h))y=!0,n[g]=null;else{if(void 0===w)return;d=!0,n[g]=w}}return y&&(e.partial=!0),c&&y&&!d?void 0:n}},X=function(e,t,r,n,i,a,c){if(Array.isArray(c)){for(var l=e.schemaPredicates,f=void 0===l||l.isListNullable(t,r),v=new Array(c.length),d=0,y=c.length;d<y;d++){var h=X(e,t,r,O(n,""+d),i,void 0!==a?a[d]:void 0,c[d]);if(void 0===h&&!f)return;v[d]=void 0!==h?h:null}return v}if(null==c)return null;if(Z(c)){var m=void 0===a?Object.create(null):a;return"string"==typeof c?J(e,c,i,m):function(e,t,r,n,i){var a=e.store,c=e.schemaPredicates,l=a.keyOfEntity(i)||t;C(l);var f=i.__typename,v=a.getField(l,"__typename")||f;if(!("string"!=typeof v||f&&v!==f)){n.__typename=v;for(var d,y=new x(v,l,r,e),h=!1,m=!1;void 0!==(d=y.next());){var g=o(d),b=s(d),k=O(l,_(g,p(d,e.variables))),w=a.getRecord(k),N=i[g],S=void 0;if(void 0!==N&&void 0===d.selectionSet)S=N;else if(void 0===d.selectionSet)S=w;else if(void 0!==N)S=X(e,v,g,k,u(d),n[b],N);else{var q=a.getLink(k);void 0!==q?S=Y(e,q,v,g,u(d),n[b]):"object"==typeof w&&null!==w&&(S=w)}if(void 0===S&&void 0!==c&&c.isFieldNullable(v,g))m=!0,n[b]=null;else{if(void 0===S)return;h=!0,n[b]=S}}return m&&(e.partial=!0),h?n:void 0}}(e,n,i,m,c)}},Y=function(e,t,r,n,i,o){if(Array.isArray(t)){for(var a=e.schemaPredicates,s=void 0!==a&&a.isListNullable(r,n),u=new Array(t.length),c=0,l=t.length;c<l;c++){var f=Y(e,t[c],r,n,i,void 0!==o?o[c]:void 0);if(void 0===f&&!s)return;u[c]=void 0!==f?f:null}return u}return null===t?null:J(e,t,i,void 0===o?Object.create(null):o)},Z=function(e){return"string"==typeof e||"object"==typeof e&&"string"==typeof e.__typename},$=function(t){this.schema=e.buildClientSchema(t)};$.prototype.isFieldNullable=function(t,r){var n=ee(this.schema,t,r);return void 0!==n&&e.isNullableType(n.type)},$.prototype.isListNullable=function(t,r){var n=ee(this.schema,t,r);if(void 0===n)return!1;var i=e.isNonNullType(n.type)?n.type.ofType:n.type;return e.isListType(i)&&e.isNullableType(i.ofType)},$.prototype.isFieldAvailableOnType=function(e,t){return!!ee(this.schema,e,t)},$.prototype.isInterfaceOfType=function(t,r){if(!r||!t)return!1;if(r===t)return!0;var n=this.schema.getType(t),i=this.schema.getType(r);return n instanceof e.GraphQLObjectType?n===i:(re(n),te(i),this.schema.isPossibleType(n,i))};var ee=function(e,t,r){var n=e.getType(t);te(n);var i=n.getFields()[r];if(void 0!==i)return i},te=function(t,r){d(t instanceof e.GraphQLObjectType,"",3)},re=function(t,r){d(t instanceof e.GraphQLInterfaceType||t instanceof e.GraphQLUnionType,"",5)},ne=function(e,t){return i(i({},e),{context:i(i({},e.context),{meta:i(i({},e.context.meta),{cacheOutcome:t})})})},ie=function(e){return i(i({},e),{query:t.formatDocument(e.query)})},oe=function(e){return e.context.requestPolicy},ae=function(e){return"query"===e.operationName},se=function(e){return ae(e)&&"network-only"!==oe(e)},ue=function(e,t){return i(i({},e),{context:i(i({},e.context),{requestPolicy:t})})};function ce(e){return se(e)}function le(e){return ne(e.operation,e.outcome)}function fe(e){return"miss"===e.outcome}function pe(e){return"miss"!==e.outcome}function ve(e){return!se(e)}exports.Store=V,exports.cacheExchange=function(e){return function(t){var r=t.forward,i=t.client;e||(e={});var o=new V(e.schema?new $(e.schema):void 0,e.resolvers,e.updates,e.optimistic,e.keys),a=new Set,s=new Map,u=Object.create(null),c=function(e,t){void 0!==t&&t.forEach((function(t){var r=u[t];if(void 0!==r){u[t]=[];for(var n=0,i=r.length;n<i;n++)e.add(r[n])}}))},l=function(e,t){t.forEach((function(t){if(t!==e.key){var r=s.get(t);void 0!==r&&(s.delete(t),i.reexecuteOperation(ue(r,"cache-first")))}}))},f=function(e){if(function(e){return"mutation"===e.operationName}(i=e)&&"network-only"!==oe(i)){var t=e.key,r=F(o,e,t).dependencies;if(0!==r.size){a.add(t);var n=new Set;c(n,r),l(e,n)}}var i},p=function(e,t){t.forEach((function(t){(u[t]||(u[t]=[])).push(e.key),s.has(e.key)||s.set(e.key,"network-only"===oe(e)?ue(e,"cache-and-network"):e)}))},v=function(e){var t,r=U(o,e),n=r.data,i=r.partial;return null===n?t="miss":(p(e,r.dependencies),t=i&&"cache-only"!==oe(e)?"partial":"hit"),{outcome:t,operation:e,data:n}},d=function(e){var t,r,n=e.operation,i=e.error,s=e.extensions,u=ae(n),f=e.data,v=n.key;if(a.has(v)&&(a.delete(v),o.clearOptimistic(v)),null!=f)if(t=S(o,n,f).dependencies,u){var d=U(o,n);f=d.data,r=d.dependencies}else f=U(o,n,f).data;var y=new Set;return c(y,t),u&&c(y,r),l(e.operation,y),u&&void 0!==r&&p(e.operation,r),{data:f,error:i,extensions:s,operation:n}};function y(e){var t=e.operation,r=e.outcome,n=oe(t),o={operation:ne(t,r),data:e.data,error:e.error,extensions:e.extensions};return("cache-and-network"===n||"cache-first"===n&&"partial"===r)&&(o.stale=!0,i.reexecuteOperation(ue(t,"network-only"))),o}return function(e){var t=n.share(n.tap(f)(n.map(ie)(e))),i=n.share(n.map(v)(n.filter(ce)(t))),o=n.map(le)(n.filter(fe)(i)),a=n.map(y)(n.filter(pe)(i)),s=n.map(d)(r(n.merge([n.filter(ve)(t),o])));return n.merge([s,a])}}},exports.query=U,exports.read=W,exports.write=S,exports.writeFragment=T,exports.writeOptimistic=F;
//# sourceMappingURL=urql-exchange-graphcache.min.js.map
