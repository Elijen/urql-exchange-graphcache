"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("graphql"),t=require("urql"),r=require("wonka");function n(){return(n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var i=function(e){return e.name.value},o=function(e){return e.typeCondition.name.value},a=function(e){return void 0!==e.alias?e.alias.value:i(e)},s=function(e){return void 0!==e.selectionSet?e.selectionSet.selections:[]},u=function(e){var t=e.typeCondition;return void 0!==t?i(t):null},c=function(t){return t.kind===e.Kind.FIELD},l=function(t){return t.kind===e.Kind.INLINE_FRAGMENT},f=function(t,r){if(void 0===t.arguments||0===t.arguments.length)return null;for(var n=Object.create(null),o=0,a=0,s=t.arguments.length;a<s;a++){var u=t.arguments[a],c=e.valueFromASTUntyped(u.value,r);null!=c&&(n[i(u)]=c,o++)}return o>0?n:null},p=function(t,r){if(void 0===t.variableDefinitions)return{};var n=r||{};return t.variableDefinitions.reduce((function(t,r){var o=i(r.variable),a=n[o];if(void 0===a){if(void 0===r.defaultValue)return t;a=e.valueFromASTUntyped(r.defaultValue,n)}return t[o]=a,t}),Object.create(null))},v=function(e,t,r){if(!e){var n=new Error((t||"Minfied Error #"+r+"\n")+"\nhttps://github.com/FormidableLabs/urql-exchange-graphcache/blob/master/docs/help.md#"+r);throw n.name="Graphcache Error",n}},d=function(t){return t.kind===e.Kind.FRAGMENT_DEFINITION};function y(t){return t.kind===e.Kind.OPERATION_DEFINITION}var h=function(e){var t=e.definitions.find(y);return v(!!t,"",1),t};function m(e,t){return e[i(t)]=t,e}var g=function(e){return e.definitions.filter(d).reduce(m,{})},b=function(t,r){var n=t.directives;if(void 0===n)return!0;for(var o=0,a=n.length;o<a;o++){var s=n[o],u=i(s),c="include"===u;if(c||"skip"===u){var l=s.arguments?s.arguments[0]:null;if(l&&"if"===i(l)){var f=e.valueFromASTUntyped(l.value,r);if("boolean"==typeof f||null===f)return c?!!f:!f}}}return!0},k=function(){return{optimistic:Object.create(null),base:new Map,keys:[]}},_=function(e,t){var r=e.keys.indexOf(t);return r>-1&&(delete e.optimistic[t],e.keys.splice(r,1)),e},O=function(e,t){for(var r=0,n=e.keys.length;r<n;r++){var i=e.optimistic[e.keys[r]];if(i.has(t))return i.get(t)}return e.base.get(t)},w=function(e,r){return r?e+"("+t.stringifyVariables(r)+")":e},x=function(e,t){return e+"."+t},N=function(e,t,r,n){return!(!t||t!==u(e)&&s(e).some((function(e){if(!c(e))return!1;var t=w(i(e),f(e,n.variables));return!n.store.hasField(x(r,t))})))},S=function(e,t,r,n){this.typename=e,this.entityKey=t,this.context=n,this.indexStack=[0],this.selectionStack=[r]};S.prototype.next=function(){for(;0!==this.indexStack.length;){var e=this.indexStack[this.indexStack.length-1]++,t=this.selectionStack[this.selectionStack.length-1];if(e>=t.length)this.indexStack.pop(),this.selectionStack.pop();else{var r=t[e];if(b(r,this.context.variables)){if(c(r)){if("__typename"===i(r))continue;return r}var n=l(r)?r:this.context.fragments[i(r)];void 0!==n&&(void 0!==this.context.schemaPredicates?this.context.schemaPredicates.isInterfaceOfType(u(n),this.typename):N(n,this.typename,this.entityKey,this.context))&&(this.indexStack.push(0),this.selectionStack.push(s(n)))}}}};var F=function(e){return Array.isArray(e)?e.some(F):"object"!=typeof e||null!==e&&"string"!=typeof e.__typename},T=function(e,t,r){Q(0);var n=q(e,t,r);return C(),n},q=function(e,t,r){var n=h(t.query),i={dependencies:G()},o=s(n),a=e.getRootKey(n.operation),u={parentTypeName:a,parentKey:a,parentFieldKey:"",fieldName:"",variables:p(n,t.variables),fragments:g(t.query),result:i,store:e,schemaPredicates:e.schemaPredicates};return a===u.store.getRootKey("query")?j(u,a,o,r):L(u,a,o,r),i},R=function(e,t,r){Q(r);var n=h(t.query),o={dependencies:G()},a=e.getRootKey("mutation"),u=e.getRootKey(n.operation);v(u===a,"",10);for(var c,l={parentTypeName:a,parentKey:a,parentFieldKey:"",fieldName:"",variables:p(n,t.variables),fragments:g(t.query),result:o,store:e,schemaPredicates:e.schemaPredicates,optimistic:!0},d=Object.create(null),y=new S(u,u,s(n),l);void 0!==(c=y.next());)if(void 0!==c.selectionSet){var m=i(c),b=l.store.optimisticMutations[m];if(void 0!==b){l.fieldName=m;var k=f(c,l.variables),_=b(k||Object.create(null),l.store,l);F(_)||P(l,_,s(c)),d[m]=_;var O=l.store.updates[a][m];void 0!==O&&O(d,k||Object.create(null),l.store,l)}}return C(),o},K=function(e,t,r,i){var a=g(t),u=a[Object.keys(a)[0]];if(void 0!==u){var c=o(u),l=n({__typename:c},r),f=e.keyOfEntity(l);if(f){var p={parentTypeName:c,parentKey:f,parentFieldKey:"",fieldName:"",variables:i||{},fragments:a,result:{dependencies:G()},store:e,schemaPredicates:e.schemaPredicates};j(p,f,s(u),l)}}},j=function(e,t,r,n){var o=e.store,u=t===e.store.getRootKey("query"),c=n.__typename;u||D(t),o.writeField(u?t:c,t,"__typename");for(var l,p=new S(c,t,r,e);void 0!==(l=p.next());){var v=i(l),d=f(l,e.variables),y=x(t,w(v,d)),h=n[a(l)];if(u&&D(y),void 0===l.selectionSet)o.writeRecord(h,y);else if(F(h))o.writeRecord(h,y);else{var m=A(e,y,s(l),h);o.writeConnection(x(t,v),y,d),o.writeLink(m,y),o.removeRecord(y)}}},A=function(e,t,r,n){if(Array.isArray(n)){for(var i=new Array(n.length),o=0,a=n.length;o<a;o++){var s=n[o],u=x(t,""+o),c=A(e,u,r,s);i[o]=c}return i}if(null===n)return null;var l=e.store.keyOfEntity(n),f=null!==l?l:t,p=n.__typename;return void 0===e.store.keys[n.__typename]&&null===l&&!p.endsWith("Connection")&&p.endsWith("Edge"),j(e,f,r,n),f},L=function(e,t,r,n){for(var o,u=t===e.store.getRootKey("mutation")||t===e.store.getRootKey("subscription"),c=new S(t,t,r,e);void 0!==(o=c.next());){var l=i(o),p=f(o,e.variables),v=n[a(o)];if(void 0===o.selectionSet||null===v||F(v)||P(e,v,s(o)),u){e.parentTypeName=t,e.parentKey=t,e.parentFieldKey=x(t,w(l,p)),e.fieldName=l;var d=e.store.updates[t][l];void 0!==d&&d(n,p||Object.create(null),e.store,e)}}},P=function(e,t,r){if(Array.isArray(t)){for(var n=new Array(t.length),i=0,o=t.length;i<o;i++)n[i]=P(e,t[i],r);return n}if(null!==t){var a=e.store.keyOfEntity(t);null!==a?j(e,a,r,t):L(e,t.__typename,r,t)}},E=function(e,t,r){var n,o=e.store,a="Query"===t;if(a)n=t;else{if(D(t),"string"!=typeof(n=o.getField(t,"__typename")))return;o.removeRecord(x(t,w("__typename")))}for(var u,c=new S(n,t,r,e);void 0!==(u=c.next());){var l=i(u),p=x(t,w(l,f(u,e.variables)));if(a&&D(p),void 0===u.selectionSet)o.removeRecord(p);else{var v=s(u),d=o.getLink(p);if(o.removeLink(p),void 0===d)void 0!==o.getRecord(p)&&o.removeRecord(p);else if(Array.isArray(d))for(var y=0,h=d.length;y<h;y++){var m=d[y];null!==m&&E(e,m,v)}else null!==d&&E(e,d,v)}}},M={current:null},I={current:null},Q=function(e){M.current=new Set,I.current=e},C=function(){M.current=null,I.current=null},G=function(){return v(null!==(e=M).current,"",2),e.current;var e},D=function(e){M.current.add(e)},V=function(e,t,r){return function(e,t,r,n){return 0!==n?(void 0===e.optimistic[n]&&(e.optimistic[n]=new Map,e.keys.unshift(n)),e.optimistic[n].set(t,r)):e.base.set(t,r),e}(e,t,r,I.current||0)},U=function(e,t){return function(e,t,r){return 0!==r?(void 0===e.optimistic[r]&&(e.optimistic[r]=new Map,e.keys.unshift(r)),e.optimistic[r].set(t,void 0)):e.base.delete(t),e}(e,t,I.current||0)},W=function(e,t,r,n,i){var o;if(this.records=k(),this.connections=k(),this.links=k(),this.resolvers=t||{},this.optimisticMutations=n||{},this.keys=i||{},this.schemaPredicates=e,this.updates={Mutation:r&&r.Mutation||{},Subscription:r&&r.Subscription||{}},e){var a=e.schema,s=a.getQueryType(),u=a.getMutationType(),c=a.getSubscriptionType(),l=s?s.name:"Query",f=u?u.name:"Mutation",p=c?c.name:"Subscription";this.rootFields={query:l,mutation:f,subscription:p},this.rootNames=((o={})[l]="query",o[f]="mutation",o[p]="subscription",o)}else this.rootFields={query:"Query",mutation:"Mutation",subscription:"Subscription"},this.rootNames={Query:"query",Mutation:"mutation",Subscription:"subscription"}};W.prototype.getRootKey=function(e){return this.rootFields[e]},W.prototype.keyOfEntity=function(e){var t,r=e.__typename,n=e.id,i=e._id;return r?void 0!==this.rootNames[r]?r:(this.keys[r]?t=this.keys[r](e):null!=n?t=""+n:null!=i&&(t=""+i),t?r+":"+t:null):null},W.prototype.clearOptimistic=function(e){this.records=_(this.records,e),this.connections=_(this.connections,e),this.links=_(this.links,e)},W.prototype.getRecord=function(e){return O(this.records,e)},W.prototype.removeRecord=function(e){return this.records=U(this.records,e)},W.prototype.writeRecord=function(e,t){return this.records=V(this.records,t,e)},W.prototype.getField=function(e,t,r){return this.getRecord(x(e,w(t,r)))},W.prototype.writeField=function(e,t,r,n){return this.records=V(this.records,x(t,w(r,n)),e)},W.prototype.getLink=function(e){return O(this.links,e)},W.prototype.removeLink=function(e){return this.links=U(this.links,e)},W.prototype.writeLink=function(e,t){return this.links=V(this.links,t,e)},W.prototype.writeConnection=function(e,t,r){if(void 0!==this.getLink(t)||null===r)return this.connections;var n=O(this.connections,e),i=[r,t];if(void 0===n)n=[i];else{for(var o=0,a=n.length;o<a;o++)if(n[o][1]===t)return this.connections;(n=n.slice()).push(i)}return this.connections=V(this.connections,e,n)},W.prototype.resolveValueOrLink=function(e){var t=this.getRecord(e);return void 0!==t?t:this.getLink(e)||null},W.prototype.resolve=function(e,t,r){if(null===e)return null;if("string"==typeof e)return D(e),this.resolveValueOrLink(x(e,w(t,r)));var n=this.keyOfEntity(e);return null===n?null:(D(n),this.resolveValueOrLink(x(n,w(t,r))))},W.prototype.resolveConnections=function(e,t){var r;if("string"==typeof e)r=O(this.connections,x(e,t));else if(null!==e){var n=this.keyOfEntity(e);null!==n&&(D(n),r=O(this.connections,x(n,t)))}return void 0!==r?r:[]},W.prototype.invalidateQuery=function(e,r){!function(e,t){Q(0);var r=h(t.query),n={variables:p(r,t.variables),fragments:g(t.query),store:e,schemaPredicates:e.schemaPredicates};E(n,n.store.getRootKey("query"),s(r)),C()}(this,t.createRequest(e,r))},W.prototype.hasField=function(e){return void 0!==this.getRecord(e)||void 0!==this.getLink(e)},W.prototype.updateQuery=function(e,r){var n=t.createRequest(e.query,e.variables),i=r(this.readQuery(n));null!==i&&q(this,n,i)},W.prototype.readQuery=function(e){return B(this,t.createRequest(e.query,e.variables)).data},W.prototype.readFragment=function(e,t,r){return X(this,e,t,r)},W.prototype.writeFragment=function(e,t,r){K(this,e,t,r)};var z=function(e,t,r){Q(0);var n=B(e,t,r);return C(),n},B=function(e,t,r){var n=h(t.query),i=e.getRootKey(n.operation),o=s(n),a={parentTypeName:i,parentKey:i,parentFieldKey:"",fieldName:"",variables:p(n,t.variables),fragments:g(t.query),partial:!1,store:e,schemaPredicates:e.schemaPredicates},u=r||Object.create(null);return u=i!==a.store.getRootKey("query")?H(a,i,o,u):Y(a,i,o,u),{dependencies:G(),partial:void 0!==u&&a.partial,data:void 0===u?null:u}},H=function(e,t,r,n){if("string"!=typeof n.__typename)return n;var i=Object.create(null);i.__typename=n.__typename;for(var o,u=new S(t,t,r,e);void 0!==(o=u.next());){var c=a(o),l=n[c];i[c]=void 0===o.selectionSet||null===l||F(l)?l:J(e,s(o),l)}return i},J=function(e,t,r){if(Array.isArray(r)){for(var n=new Array(r.length),i=0,o=r.length;i<o;i++)n[i]=J(e,t,r[i]);return n}if(null===r)return null;var a=e.store.keyOfEntity(r);if(null!==a){var s=Y(e,a,t,Object.create(null));return void 0===s?null:s}return H(e,r.__typename,t,r)},X=function(e,t,r,i){var a=g(t),u=a[Object.keys(a)[0]];if(void 0===u)return null;var c=o(u);"string"==typeof r||r.__typename||(r.__typename=c);var l="string"!=typeof r?e.keyOfEntity(n({__typename:c},r)):r;return l&&Y({parentTypeName:c,parentKey:l,parentFieldKey:"",fieldName:"",variables:i||{},fragments:a,partial:!1,store:e,schemaPredicates:e.schemaPredicates},l,s(u),Object.create(null))||null},Y=function(e,t,r,n){var o=e.store,u=e.schemaPredicates,c=t===o.getRootKey("query");c||D(t);var l=c?t:o.getField(t,"__typename");if("string"==typeof l){n.__typename=l;for(var p,v=new S(l,t,r,e),d=!1,y=!1;void 0!==(p=v.next());){var h=i(p),m=f(p,e.variables),g=a(p),b=x(t,w(h,m)),k=o.getRecord(b);c&&D(b);var _=void 0,O=o.resolvers[l];if(void 0!==O&&"function"==typeof O[h]){e.parentTypeName=l,e.parentKey=t,e.parentFieldKey=b,e.fieldName=h,void 0!==k&&(n[g]=k);var N=O[h](n,m||Object.create(null),o,e);_=void 0!==p.selectionSet?Z(e,l,h,b,s(p),n[g]||Object.create(null),N):void 0===N&&void 0===u?null:N}else if(void 0===p.selectionSet)_=k;else{var F=o.getLink(b);void 0!==F?_=$(e,F,l,h,s(p),n[g]):"object"==typeof k&&null!==k&&(_=k)}if(void 0===_&&void 0!==u&&u.isFieldNullable(l,h))y=!0,n[g]=null;else{if(void 0===_)return;d=!0,n[g]=_}}return y&&(e.partial=!0),c&&y&&!d?void 0:n}},Z=function(e,t,r,n,o,u,c){if(Array.isArray(c)){for(var l=e.schemaPredicates,p=void 0===l||l.isListNullable(t,r),v=new Array(c.length),d=0,y=c.length;d<y;d++){var h=Z(e,t,r,x(n,""+d),o,void 0!==u?u[d]:void 0,c[d]);if(void 0===h&&!p)return;v[d]=void 0!==h?h:null}return v}if(null==c)return null;if(ee(c)){var m=void 0===u?Object.create(null):u;return"string"==typeof c?Y(e,c,o,m):function(e,t,r,n,o){var u=e.store,c=e.schemaPredicates,l=u.keyOfEntity(o)||t;D(l);var p=o.__typename,v=u.getField(l,"__typename")||p;if(!("string"!=typeof v||p&&v!==p)){n.__typename=v;for(var d,y=new S(v,l,r,e),h=!1,m=!1;void 0!==(d=y.next());){var g=i(d),b=a(d),k=x(l,w(g,f(d,e.variables))),_=u.getRecord(k),O=o[g],N=void 0;if(void 0!==O&&void 0===d.selectionSet)N=O;else if(void 0===d.selectionSet)N=_;else if(void 0!==O)N=Z(e,v,g,k,s(d),n[b],O);else{var F=u.getLink(k);void 0!==F?N=$(e,F,v,g,s(d),n[b]):"object"==typeof _&&null!==_&&(N=_)}if(void 0===N&&void 0!==c&&c.isFieldNullable(v,g))m=!0,n[b]=null;else{if(void 0===N)return;h=!0,n[b]=N}}return m&&(e.partial=!0),h?n:void 0}}(e,n,o,m,c)}},$=function(e,t,r,n,i,o){if(Array.isArray(t)){for(var a=e.schemaPredicates,s=void 0!==a&&a.isListNullable(r,n),u=new Array(t.length),c=0,l=t.length;c<l;c++){var f=$(e,t[c],r,n,i,void 0!==o?o[c]:void 0);if(void 0===f&&!s)return;u[c]=void 0!==f?f:null}return u}return null===t?null:Y(e,t,i,void 0===o?Object.create(null):o)},ee=function(e){return"string"==typeof e||"object"==typeof e&&"string"==typeof e.__typename},te=function(t){this.schema=e.buildClientSchema(t)};te.prototype.isFieldNullable=function(t,r){var n=re(this.schema,t,r);return void 0!==n&&e.isNullableType(n.type)},te.prototype.isListNullable=function(t,r){var n=re(this.schema,t,r);if(void 0===n)return!1;var i=e.isNonNullType(n.type)?n.type.ofType:n.type;return e.isListType(i)&&e.isNullableType(i.ofType)},te.prototype.isFieldAvailableOnType=function(e,t){return!!re(this.schema,e,t)},te.prototype.isInterfaceOfType=function(t,r){if(!r||!t)return!1;if(r===t)return!0;var n=this.schema.getType(t),i=this.schema.getType(r);return n instanceof e.GraphQLObjectType?n===i:(ie(n),ne(i),this.schema.isPossibleType(n,i))};var re=function(e,t,r){var n=e.getType(t);ne(n);var i=n.getFields()[r];if(void 0!==i)return i},ne=function(t,r){v(t instanceof e.GraphQLObjectType,"",3)},ie=function(t,r){v(t instanceof e.GraphQLInterfaceType||t instanceof e.GraphQLUnionType,"",5)},oe=function(e,t){return n(n({},e),{context:n(n({},e.context),{meta:n(n({},e.context.meta),{cacheOutcome:t})})})},ae=function(e){return n(n({},e),{query:t.formatDocument(e.query)})},se=function(e){return e.context.requestPolicy},ue=function(e){return"query"===e.operationName},ce=function(e){return ue(e)&&"network-only"!==se(e)},le=function(e,t){return n(n({},e),{context:n(n({},e.context),{requestPolicy:t})})};function fe(e){return ce(e)}function pe(e){return oe(e.operation,e.outcome)}function ve(e){return"miss"===e.outcome}function de(e){return"miss"!==e.outcome}function ye(e){return!ce(e)}exports.Store=W,exports.cacheExchange=function(e){return function(t){var n=t.forward,i=t.client;e||(e={});var o=new W(e.schema?new te(e.schema):void 0,e.resolvers,e.updates,e.optimistic,e.keys),a=new Set,s=new Map,u=Object.create(null),c=function(e,t){void 0!==t&&t.forEach((function(t){var r=u[t];if(void 0!==r){u[t]=[];for(var n=0,i=r.length;n<i;n++)e.add(r[n])}}))},l=function(e,t){t.forEach((function(t){if(t!==e.key){var r=s.get(t);void 0!==r&&(s.delete(t),i.reexecuteOperation(le(r,"cache-first")))}}))},f=function(e){if(function(e){return"mutation"===e.operationName}(i=e)&&"network-only"!==se(i)){var t=e.key,r=R(o,e,t).dependencies;if(0!==r.size){a.add(t);var n=new Set;c(n,r),l(e,n)}}var i},p=function(e,t){t.forEach((function(t){(u[t]||(u[t]=[])).push(e.key),s.has(e.key)||s.set(e.key,"network-only"===se(e)?le(e,"cache-and-network"):e)}))},v=function(e){var t,r=z(o,e),n=r.data,i=r.partial;return null===n?t="miss":(p(e,r.dependencies),t=i&&"cache-only"!==se(e)?"partial":"hit"),{outcome:t,operation:e,data:n}},d=function(e){var t,r,n=e.operation,i=e.error,s=e.extensions,u=ue(n),f=e.data,v=n.key;if(a.has(v)&&(a.delete(v),o.clearOptimistic(v)),null!=f)if(t=T(o,n,f).dependencies,u){var d=z(o,n);f=d.data,r=d.dependencies}else f=z(o,n,f).data;var y=new Set;return c(y,t),u&&c(y,r),l(e.operation,y),u&&void 0!==r&&p(e.operation,r),{data:f,error:i,extensions:s,operation:n}};function y(e){var t=e.operation,r=e.outcome,n=se(t),o={operation:oe(t,r),data:e.data,error:e.error,extensions:e.extensions};return("cache-and-network"===n||"cache-first"===n&&"partial"===r)&&(o.stale=!0,i.reexecuteOperation(le(t,"network-only"))),o}return function(e){var t=r.share(r.tap(f)(r.map(ae)(e))),i=r.share(r.map(v)(r.filter(fe)(t))),o=r.map(pe)(r.filter(ve)(i)),a=r.map(y)(r.filter(de)(i)),s=r.map(d)(n(r.merge([r.filter(ye)(t),o])));return r.merge([s,a])}}},exports.query=z,exports.read=B,exports.write=T,exports.writeFragment=K,exports.writeOptimistic=R;
//# sourceMappingURL=urql-exchange-graphcache.min.js.map
